# Управление пакетами. Дистрибуция софта.

### 1. make
### 1. rpm
### 1. yum
### 1. docker

---

1. make - самый первый, из существующих, метод сборки и установки ПО из исходников.  
    1. `Makefile` - файл, описывающий ДИРЕКТИВЫ (что и как будет сделано)  
    1. `make [ДИРЕКТИВА]` - запуск сборки и установки ПО по определённой директиве  
    1. Плюсы и минусы make:
    - Плюсы:
        - Возможность использовать версию ПО, которой нет в репозиториях (самую новую или устаревшую)
        - Возможность собрать ПО с модулями/опциями необходимыми в конкретном случае для конкретных целей
        - Нет необходимости разбираться с созданием пакета и создавать сложные "обёртки" для сборки
    - Минусы:
        - Требует сборочное окружение на сервере
            - облегчает сборку эксплойта при компрометации сервера
            - сборочное окружение не является необходимым для работы ПО (замусоривает систему)
        - Занимает много времени
        - Все зависимости нужно искать и устанавливать вручную
        - Сложно распространять (вместо одного пакета отправляется ряд файлов для сборки)
        - Возможны трудности с unit'ами и init-скриптами (автозапуск, старт/стоп/перезапуск)
        - Больше трудозатрат на поддержание системы (необходимость следить за обновлениями безопасности и обновлять вручную)
        - Часто отсутствуют директивы-деинсталяторы
        - При деинсталяции удаляются конфигурационный файлы, необходимо обеспечивать их резервное хранение

1. rpm - пакетный менеджер, упрощающий установку ПО в системе. 
    1. Файлы с расширением `.rpm` - называются `RPM-пакетами`. RPM-пакет можно рассматривать как умный gzip-архив. По сути являются дистрибутивами с ПО.
        1. Структура rpm-пакета:
            - Метаинформация:
                - Имя
                - Версия
                - Релиз
                - Архитектура
                - Зависимости
                - Ресурсы
                - ...
            - Файлы
            - Скриптлеты:
                - pre-install
                - post-install
                - pre-remove
                - post-remove
                - ...
        1. Типовые команды rpm:
            - `rpm -q ИМЯ_ПАКЕТА` - проверить установлен ли пакет
            - `rpm -qi ИМЯ_ПАКЕТА` - показать мета информацию о пакете
            - `rpm -e ИМЯ_ПАКЕТА` - удалить пакет
            - `rpm -i ДИСТРИБУТИВ` - установить пакет из дистрибутива
            - `rpm -ql ИМЯ_ПАКЕТА` - вывести список файлов пакета
            - `rpm -q --scripts ИМЯ_ПАКЕТА` - показать скриптлеты пакета
            - `rpm -qR ИМЯ ПАКЕТА` - показать зависимости пакета
            - `rpm -q --provides ИМЯ_ПАКЕТА` - показать ресурсы предоставляемые пакетом
            - `rpm -qf ФАЙЛ` - показать какому пакету принадлежит `ФАЙЛ`
            - Дополнительные опции:
                - `p ДИСТРИБУТИВ` - получить информацию вместо пакета, о конкретном дистрибутиве (указывается путь к файлу)
                - `--queryformat %{VERSION}-%{RELEASE}` - задаёт формат вывода
            - `rpm2cpio ДИСТРИБУТИВ | cpio -idmv` - распаковать содержимое дистрибутива
        1. Плюсы и минусы RPM-пакетов:
            - Плюсы:
                - содержат уже собранное ПО, поддерживаемое командой поддержки репозитория/дистрибутива
                - при установке не происходит сборки/компиляции ПО
                - крайне низкие трудозатраты на установку ПО
                - присутствуют данные о зависимостях
                - большинство пакетов разбиты на binary/dev-подпакеты, нет мусора в ОС
                - для установки ПО не нужно окружение для сборки, меньше софта в ОС
                - возможность автоматически выполнять скрипты при установке/удалении
            - Минусы:
                - замороженные версии софта, не всегда последние
                - необходимо вручную устанавливать обусловленные зависимости
    1. Сборка rpm-пакетов:
        1. `rpmdevtools rpm-build` - необходимые пакеты для сборки
        1. `rpmdev-setuptree` - создаёт директории, необходимые для сборки rpm-пакета
            - `BUILD` - директория, в которой происходит сборка
            - `BUILDROOT` - директория-корень файловой системы, на которую накатывается пакет
            - `RPMS` - директория с собранными пакетами
            - `SOURCES` - директория с исходными файлами
            - `SPECS` - директория с spec-файлами
            - `SRPMS` - директория с SRPM-пакетами
        1. `vim ИМЯ.spec` - создаст шаблон файла spec
        1. сборка пакета:
            - `rpmbuild -bb ИМЯ.spec` - сборка RPM
            - `rpmbuild -bs ИМЯ.spec` - сборка SRPM
            - `rpmbuild -ba ИМЯ.spec` - сборка RPM+SRPM
        1. загрузка исходных файлов и зависимостей для дистрибутива:
            - `yum-utils` - необходимый пакет, содержащий в себе ПО для загрузки дистрибутивов
            - `yumdownloader --source ИМЯ_ПАКЕТА` - загрузить исходные файлы пакета
            - `yum-buildep ИМЯ_ПАКЕТА/ИМЯ.spec` - загрузка зависимостей по имени пакета или информации из файла spec
        1. сборка пакета для разных ОС:
            - `mock mock-rpmfusion-free` - пакеты, содержащие в себе ПО позволяющие собирать пакеты для разных ОС
            - `/etc/mock/` - директория, содержащая файлы с инструкциями `mock` по сборке для определённой ОС

1. yum - ПО для управления и автоматизации работы rpm. Позволяет реализовать скачивание пакета, автоматическое разрешение зависимостей, обновления и разные другие полезные функции.
    1. Файлы yum:
        - `/etc/yum.conf` - конфигурационный файл в ini-формате
        - `/etc/yum.repos.d/*.repo` - файлы в ini-формате, описывающие репозитории
    1. Основные команды `yum`:
        - `yum search ИМЯ_ПАКЕТА` - поиск пакета
        - `yum install ИМЯ_ПАКЕТА` - установка пакета(ов)
        - `yum update ИМЯ_ПАКЕТА` - обновление пакета (всех пакетов, если не указан конкретный) до последней версии (или конкретной, если указана)
        - `yum downgrade ИМЯ_ПАКЕТА` - откат пакета до указанной версии
        - `yum remove ИМЯ_ПАКЕТА` - удаление пакета
        - `yum info ИМЯ_ПАКЕТА` -  информация о пакете
        - `yum provides КОМАНДА` - найти из какого пакета команда (исполняемый файл)
        - `yum provides */ИМЯ_ФАЙЛА` - найти из какого пакета файл
        - `yum shell` - CLI
        - `yum history` - история действий `yum`
        - `yum history info N` - посмотреть информацию об изменениях `yum` в действии `N`
        - `yum updateinfo list security all` - вывести информацию по обновлениям безопасности
        - `yum updateinfo list security all` - вывести информацию по установленным обновлениям безопасности
        - `yum update --security -y` - установить обновления безопасности
        - `yum update-minimal --security -y`- установить минимальные обновления безопасности

1. docker - средство для стандартизации, иммутабельности (возможность работы вне зависимости от окружения), воспроизводимости сервиса/приложения с помощью `контейнеров`.
    - `Контейнер` - приложение или сервис, упакованные в изолированное окружение (используются механизмы cgroups и chroot)
    - Потребление ресурсов контейнером можно ограничить

    
---

## Выводы:
1. `make` - __устаревший способ__ сборки, установки и доставки ПО. Крайне не рекомендуется его использовать.
1. `rpm-пакеты` - __предпочтительный вариант__ сборки, установки и доставки ПО.
1. `mock` - __ПО__, позволяющее __собрать__ пакеты __для разных ОС и__ их __версий__.
1. `yum` - менеджер обновлений, позволяющий __автоматически найти и установить__ зависимости. Так же обладает рядом других функций, наиболее полезные в текущем контексте - __загрузить пакет__ и/или __зависимости пакета__.
1. `docker контейнеры` - ещё один вариант сборки и доставки ПО. Позволяет __запустить изолированную среду, с__ уже установленным и __готовым к работе приложением/сервисом__.