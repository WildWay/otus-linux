# Загрузка системы.

1. Чем UEFI отличается от BIOS
1. Процесс загрузки BIOS, UEFI, PXE/PXE EFI
1. За что отвечают initrd & root fs
1. Из чего состоит GRUB 2
1. initrd и dracut
1. Выводы


---

1. ### Чем UEFI отличается от BIOS

    __2 основных отличия:__
    1. UEFI поддерживает диски носители более 2 ТБ
    2. UEFI может загружать систему без наличия загрузочной записи на диске

    Так же есть ряд других отличий, при этом наиболее важны именно эти.  
    Подробная информация в следующих статьях:
    - [UEFI boot: how does that actually work, then? By AdamW, Red Hat](https://www.happyassassin.net/2014/01/25/uefi-boot-how-does-that-actually-work-then/)
    - [UEFI FAQ](https://uefi.org/faq)


1. ### Процесс загрузки BIOS, UEFI, PXE/PXE EFI
    - Стадии загрузки BIOS:
        1. BIOS
        1. 1 стадия загрузки GRUB (1ый сектор загрузочной записи)
        1. 1,5 стадия загрузки GRUB (1-62 секторы загрузочной записи)
        1. 2 стадия загрузки GRUB (/boot/grub)
        1. Загрузка ядра и initrd
        1. Запуск ядра
    - Стадии загрузки UEFI:
        1. UEFI
        1. 1 стадия загрузки GRUB (раздел fat32)
        1. 2 стадия загрузки GRUB (/boot/grub)
        1. Загрузка ядра и initrd
        1. Запуск ядра
    - Стадии загрузки PXE и PXE.EFI
        1. PXE / PXE.EFI
        1. SYSLINUX (PXELINUX 0) / 2 стадия загрузки GRUB (Статический EFI)
        1. Загрузка ядра и initrd
        1. Запуск ядра


1. ### За что отвечают initrd и root fs
    - __initrd:__
        - инициализация ядра
        - запуск /sbin/init
        - загрузка модулей и некоторые типы инициализации
        - монтирование корня
            - mount /
            - pivot_root()

        __initrd__ - это cpio архив  
        __inintramfs__ - область памяти, где находится initrd

    - __root fs:__
        - монтирование остальных разделов
        - инициализация сети и запуск сервисов


1. ### Из чего состоит GRUB 2:
    - /boot/ - отдельный раздел, не должен быть на RAID (обычно ext2)
        - initramfs - загрузчик
        - vmlinuz - ядро
    - /boot/efi/ - подраздел для EFI (vfat)
    - /boot/grub2/ - конфигурационные файлы и модули
        - System.map - карта всех функций ядра
        - grub.cfg - содержит параметры загрузки
        - i386-pc - различные модули используемые grub и initrd

    Сборка grub2:    
    - /etc/grub.d/ - __shell-скрипты, которые используются скриптом__
    - /usr/sbin/grub2-mkconfig - __используя параметры из__
    - /etc/default/grub - __собирая результирующий конфигурационный файл в файл__
    - /etc/grub2.cfg - __являющий симлинком на реальный конфиг (расположение отличается на разных ОС)__


    __Если используется RAID с типом загрузки BIOS__ - раздел __/boot__ должен быть сформирован __зеркалом на каждом диске__, т.к. в случае перезагрузки системы нет гарантий что загрузка пойдёт именно с того диска, на котором есть раздел /boot. 


1. ### initrd и dracut:

    В CentOS, RHEL, Fedora и некоторых других дистрибутивах для управления initrd используется dracut.  
    С помощью dracut можно просматривать и модифицировать содержимое initrd и вставлять свои скрипты в разные этапы загрузки.

    __Этапы загрузки initrd:__
    1. cmdline - начало загрузки initrd
    1. pre-udev - перед запуском udev-подсистемы
    1. pre-trigger - в процессе запуска udev-подсистемы, возможно с ней взаимодействовать
    1. pre-mount - перед монтированием файловых систем
    1. mount - монтирование root (корневой файловой системы)
    1. pre-pivot - после монтирования, перед pivot_root
    1. cleanup - перед pivot_root, для очистки более не нужных файлов

---


### Выводы

1. UEFI наиболее полезен при использовании носителей более 2 ТБ
1. Если используется RAID с типом загрузки BIOS - раздел boot должен быть сформирован зеркалом на каждом диске
1. С помощью dracut можно модифицировать initrd на необходимом этапе загрузки